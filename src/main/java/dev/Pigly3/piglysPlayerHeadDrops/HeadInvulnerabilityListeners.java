package dev.Pigly3.piglysPlayerHeadDrops;

import com.destroystokyo.paper.profile.PlayerProfile;
import org.bukkit.Material;
import org.bukkit.NamespacedKey;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Item;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageEvent;
import org.bukkit.event.entity.ItemDespawnEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.SkullMeta;
import org.bukkit.persistence.PersistentDataType;
import org.bukkit.plugin.Plugin;

import java.io.IOException;

public class HeadInvulnerabilityListeners implements Listener {
    PiglysPlayerHeadDrops plugin;
    APIManager api;
    public HeadInvulnerabilityListeners(PiglysPlayerHeadDrops plugin){
        this.plugin = plugin;
        this.api = plugin.api;
    }
    @EventHandler
    public void onItemDamaged(EntityDamageEvent event) throws IOException {
        if (!plugin.getConfig().getBoolean("headProtection.invulnerableHeads")) {
            if (event.getEntityType() == EntityType.ITEM){
                Item item = (Item) event.getEntity();
                ItemStack stack = item.getItemStack();
                if (stack.getType() == Material.PLAYER_HEAD){
                    NamespacedKey key = new NamespacedKey(plugin, "is_sterile_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return;
                    }
                    key = new NamespacedKey(plugin, "is_disguise_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return; //Disguise heads can be destroyed
                    }
                    key = new NamespacedKey(plugin, "is_life_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return;
                    }
                    SkullMeta meta = (SkullMeta) stack.getItemMeta();
                    PlayerProfile profile = meta.getPlayerProfile();
                    key = new NamespacedKey(plugin, "is_revive_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return;
                    }
                    if (plugin.getConfig().getBoolean("lifeSystem.enabled")) {
                        api.addLife(profile.getName());
                    }
                }
            }
            return;
        }
        if (event.getEntity().getType() == EntityType.ITEM){
            Item item = (Item) event.getEntity();
            if (item.getItemStack().getType() == Material.PLAYER_HEAD){
                event.setCancelled(true);
            }
        }
    }
    @EventHandler
    public void onItemDespawn(ItemDespawnEvent event) throws IOException {
        if (plugin.getConfig().getBoolean("headProtection.headsDespawn")) {
            if (event.getEntityType() == EntityType.ITEM){
                Item item = (Item) event.getEntity();
                ItemStack stack = item.getItemStack();
                if (stack.getType() == Material.PLAYER_HEAD){
                    NamespacedKey key = new NamespacedKey(plugin, "is_sterile_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return;
                    }
                    key = new NamespacedKey(plugin, "is_disguise_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return; //Disguise heads can be destroyed
                    }
                    key = new NamespacedKey(plugin, "is_life_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return;
                    }
                    SkullMeta meta = (SkullMeta) stack.getItemMeta();
                    PlayerProfile profile = meta.getPlayerProfile();
                    key = new NamespacedKey(plugin, "is_revive_head");
                    if (Boolean.TRUE.equals(stack.getItemMeta().getPersistentDataContainer().get(key, PersistentDataType.BOOLEAN))){
                        return;
                    }
                    if (plugin.getConfig().getBoolean("lifeSystem.enabled")) {
                        api.addLife(profile.getName());
                    }
                }
            }
            return;
        }
        if (event.getEntity().getItemStack().getType() == Material.PLAYER_HEAD){
            event.setCancelled(true);
        }
    }
}
